{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "TPGT ISP PROD static stack. Creates RDS and parameter",
  "Parameters": {
    "ParamEnvName": {
      "Type": "String",
      "Description": "Stack environment name",
      "Default": "prod",
      "AllowedValues": [
        "prod"
      ],
      "ConstraintDescription": "Allowed value is prod"
    },
    "ParamVpc": {
      "Type": "String",
      "Description": "VPC ID",
      "Default": "vpc-0b54c8f0cbd685f53" 
    },
    "ParamKmsCmk": {
      "Type": "String",
      "Description": "KMS CMK ARN for encryption",
      "Default": "arn:aws:kms:ap-southeast-2:655313030751:key/2826ab72-2ed7-4f90-a386-cb1da2bf0b6c"
    },
    "ParamPrivateSubnetIdA": {
      "Type": "String",
      "Description": "Private subnet ID A",
      "Default": "subnet-077fb5a4e112368ce"
    },
    "ParamPrivateSubnetIdB": {
      "Type": "String",
      "Description": "Private subnet ID B",
      "Default": "subnet-09d3543918db4921d"
    },
    "ParamPrivateSubnetCidrA": {
      "Type": "String",
      "Description": "Private subnet CIDR A",
      "Default": "10.153.10.192/26"
    },
    "ParamPrivateSubnetCidrB": {
      "Type": "String",
      "Description": "Private subnet CIDR B",
      "Default": "10.153.10.128/26"
    },
	"ParamJumpserverSecurityGroup": {
      "Type": "String",
      "Description": "Client Windows Server for DB connection",
      "Default": "10.33.16.75/32"
    },
	"ParamHostedZone": {
      "Type": "String",
      "Description": "Route 53 zone ID",
      "Default": "Z01342843MVRCJ9TAJD67"
    }	
  },
  "Resources": {
    "MyDBInstance": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "DBName": "ORCL",
        "AllocatedStorage": 20,
        "DBInstanceClass": "db.t3.medium",
        "Engine": "oracle-ee",
        "EngineVersion": "19.0.0.0.ru-2020-04.rur-2020-04.r1",
        "CharacterSetName": "WE8MSWIN1252",
        "LicenseModel": "bring-your-own-license",
        "AssociatedRoles": [
          {
            "FeatureName": "S3_INTEGRATION",
            "RoleArn": "arn:aws:iam::655313030751:role/tpgt-prod-isp-rds-s3-monitoring-role"
          }
        ],
        "StorageType": "gp2",
        "StorageEncrypted": true,
        "KmsKeyId": "arn:aws:kms:ap-southeast-2:655313030751:key/2826ab72-2ed7-4f90-a386-cb1da2bf0b6c",
        "MasterUsername": "{{resolve:ssm:tpgt-prod-isp-dbmasteruser:1}}",
        "MasterUserPassword": "{{resolve:ssm-secure:tpgt-prod-isp-masterpassdb:1}}", 
        "BackupRetentionPeriod": 35,
        "PreferredBackupWindow": "16:00-17:00",
        "PreferredMaintenanceWindow": "Sun:13:00-Sun:15:00",
        "EnablePerformanceInsights": true,
        "PerformanceInsightsRetentionPeriod": 7,
        "EnableCloudwatchLogsExports": [
          "audit",
          "listener",
          "alert"
        ],
		"CopyTagsToSnapshot": true,
		"MonitoringInterval": 60,
        "MonitoringRoleArn": "arn:aws:iam::655313030751:role/tpgt-prod-isp-rds-monitoring-role",
        "AutoMinorVersionUpgrade": false,
        "DBInstanceIdentifier": "ISPMalware-prod-rds-instance-restored",
		"DBSnapshotIdentifier": "arn:aws:rds:ap-southeast-2:655313030751:snapshot:rds:ispmalware-prod-rds-instance-2020-09-30-16-12",
        "PubliclyAccessible": false,
        "MultiAZ": true,
        "DBSubnetGroupName": {
		  "Ref": "RDSISPDBSubnetGroup"
		},
        "VPCSecurityGroups": [ { "Fn::GetAtt": [ "RDSSecurityGroup", "GroupId" ] }],
        "OptionGroupName": {
		  "Ref": "RDSISPDBOptionGroup"
		},  
        "DBParameterGroupName": {
		  "Ref": "RDSISPParamGroup"
		},
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "-",
                [
                  "tpgt",
                  {
                    "Ref": "ParamEnvName"
                  },
                  "isp",
                  "rds"
                ]
              ]
			  
            }
		  }
          
        ]
      }
    },
    "RDSISPDBSubnetGroup": {
      "Type": "AWS::RDS::DBSubnetGroup",
      "Properties": {
        "DBSubnetGroupDescription": "Description",
        "DBSubnetGroupName": "RDS_ISP_DB_Subnet",
        "SubnetIds": [
          {
            "Ref": "ParamPrivateSubnetIdA"
          },
          {
            "Ref": "ParamPrivateSubnetIdB"
          }
        ]
      }
    },
    "RDSSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Security group for RDS",
        "VpcId": {
          "Ref": "ParamVpc"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "-",
                [
                  "tpgt",
                  {
                    "Ref": "ParamEnvName"
                  },
                  "isp",
                  "rdssecgrp"
                ]
              ]
            }
          }
        ],
        "SecurityGroupIngress": [
		  {
            "IpProtocol": "tcp",
            "FromPort": 2521,
            "ToPort": 2521,
            "SourceSecurityGroupId": {
              "Ref": "RDSClientSecurityGroup"
            }
          },
		  {
            "IpProtocol": "tcp",
            "FromPort": 2521,
            "ToPort": 2521,
            "CidrIp": {
              "Ref": "ParamJumpserverSecurityGroup"
            }
          }
        ]
      }
    },
	"RDSClientSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Security group for RDS",
        "VpcId": {
          "Ref": "ParamVpc"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "-",
                [
                  "tpgt",
                  {
                    "Ref": "ParamEnvName"
                  },
                  "isp",
                  "RDSClientsecgrp"
                ]
              ]
            }
          }
        ]
      }
    },
    "RDSISPDBOptionGroup": {
      "Type": "AWS::RDS::OptionGroup",
      "Properties": {
        "EngineName": "oracle-ee",
        "MajorEngineVersion": "19",
        "OptionGroupDescription": "Oracle DB Instance Option Group for S3 Integration",
        "OptionConfigurations": [
          {
            "OptionName": "S3_INTEGRATION",
            "OptionVersion": "1.0"
          },
          {
            "OptionName": "SSL",
            "OptionSettings": [
              {
                "Name": "SQLNET.SSL_VERSION",
                "Value": "1.2 or 1.0"
              }
            ],
            "VpcSecurityGroupMemberships": [
			  {
			    "Ref": "RDSSecurityGroup"
			  }
			],
            "Port": 2521
          },
		  {
            "OptionName": "Timezone",
            "OptionSettings": [
			{
              "Name": "TIME_ZONE",
              "Value": "Australia/Sydney"
			} 
           ]
          }
        ]
      }
    },
    "RDSISPParamGroup": {
      "Type": "AWS::RDS::DBParameterGroup",
      "Properties": {
        "Family": "oracle-ee-19",
        "Description": "CloudFormation Database Parameter Group",
        "Parameters": {
          "audit_trail": "XML, EXTENDED"
        }
      }
    },
    "RDSAlias": {
            "Type": "AWS::Route53::RecordSet",
            "Properties": {
                "HostedZoneId": {
                    "Ref": "ParamHostedZone"
                },
                "Name": {
                    "Fn::Join": [
                        ".",
                        [
                            "database",
                            {
                                "Ref": "ParamEnvName"
                            },
                            "ispmalware.aws.vodafone.com.au"
                        ]
                    ]
                },
                "Type": "CNAME",
                "TTL": "300",
                "ResourceRecords": [
                    {
                        "Fn::GetAtt": [
                            "MyDBInstance",
                            "Endpoint.Address"
                        ]
                    }
                ]
            }
		}
    },  
  "Outputs": {
    "RDSName": {
      "Description": "Oracle RDS Instance",
      "Value": {
        "Ref": "MyDBInstance"
      }
    },
    "RDSSecurityGroup": {
      "Description": "RDS security group",
      "Value": {
        "Ref": "RDSSecurityGroup"
      }
    }
  }
}